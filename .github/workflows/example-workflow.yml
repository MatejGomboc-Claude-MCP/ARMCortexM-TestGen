# Example workflow for ARMCortexM-CppLib
# Copy this to your library repo: .github/workflows/generate-tests.yml

name: Generate Tests with AI

on:
  workflow_dispatch:
    inputs:
      functions:
        description: 'Functions to generate tests for (space-separated)'
        required: true
        default: 'setBit clearBit'
        type: string
      max_cost:
        description: 'Maximum API cost in USD'
        required: false
        default: '50'
        type: string

jobs:
  generate-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 360  # 6 hours max
    
    container:
      image: ghcr.io/matejgomboc/armcortexm-cpplib-devenv:latest
      options: --user root
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Generate and validate tests
        uses: matejgomboc-claude-mcp/armcortexm-testgen@main
        with:
          functions: ${{ inputs.functions }}
          anthropic-api-key: ${{ secrets.ANTHROPIC_API_KEY }}
          max-cost: ${{ inputs.max_cost }}
      
      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'Add AI-generated tests for ${{ inputs.functions }}'
          title: 'Add tests: ${{ inputs.functions }}'
          body: |
            ## ðŸ¤– AI-Generated Tests
            
            **Functions:** `${{ inputs.functions }}`
            **Generated by:** Claude Sonnet 4.5
            **Workflow run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            
            ### âœ… Validation Results
            - All tests compile successfully
            - All tests pass (Debug, MinSize, MaxSpeed)
            - CHECK directives validated against actual assembly
            
            **Ready for review!**
          branch: ai-tests-${{ github.run_number }}
          delete-branch: true
          labels: |
            automated
            tests
            ai-generated